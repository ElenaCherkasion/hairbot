name: üîç Code Quality & Bot Health Checks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v3
        
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: üì¶ Install dependencies
        run: npm ci
        
      - name: üîç ESLint check
        run: |
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
            npx eslint . --ext .js || echo "ESLint warnings found"
          else
            echo "ESLint not configured, skipping"
          fi
        
      - name: üß™ Run unit tests
        run: |
          if [ -f "jest.config.js" ] || [ -f "__tests__" ]; then
            npm test -- --passWithNoTests
          else
            echo "No tests configured, skipping"
          fi
        
      - name: ‚öôÔ∏è Check critical files
        run: |
          echo "Checking essential files..."
          
          # –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
          [ -f "index.js" ] || { echo "‚ùå Missing index.js"; exit 1; }
          [ -f "package.json" ] || { echo "‚ùå Missing package.json"; exit 1; }
          [ -f ".env.example" ] || echo "‚ö†Ô∏è  No .env.example file"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
          [ -f "src/index.js" ] || { echo "‚ùå Missing src/index.js"; exit 1; }
          [ -d "src/handlers" ] || { echo "‚ùå Missing src/handlers directory"; exit 1; }
          
          echo "‚úÖ All critical files present"
        
      - name: üéØ Syntax validation
        run: |
          echo "Validating JavaScript syntax..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª
          node --check index.js || { echo "‚ùå Syntax error in index.js"; exit 1; }
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ .js —Ñ–∞–π–ª—ã –≤ src
          find src -name "*.js" -exec node --check {} \; || {
            echo "‚ùå Syntax errors found in src files"
            exit 1
          }
          
          echo "‚úÖ All files have valid syntax"
        
      - name: ü§ñ Bot startup smoke test
        run: |
          echo "Running bot startup smoke test..."
          
          # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π .env
          cat > .env.test << ENV
          TELEGRAM_TOKEN=test_token_123456:AAHHDDssh_test_fake_token
          DATABASE_URL=
          WEBHOOK_BASE_URL=
          PORT=3999
          NODE_ENV=test
          ENV
          
          # –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤
          echo "1. Testing module imports..."
          node -e "
            async function testImports() {
              try {
                await import('./index.js');
                console.log('‚úÖ index.js imports OK');
                
                await import('./src/index.js');
                console.log('‚úÖ src/index.js imports OK');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                if (require('fs').existsSync('./src/handlers/start.js')) {
                  await import('./src/handlers/start.js');
                  console.log('‚úÖ start.js imports OK');
                }
                
                if (require('fs').existsSync('./src/handlers/callback.js')) {
                  await import('./src/handlers/callback.js');
                  console.log('‚úÖ callback.js imports OK');
                }
                
              } catch (error) {
                console.error('‚ùå Import failed:', error.message);
                console.error('Stack trace:', error.stack.split('\\n').slice(0, 5).join('\\n'));
                process.exit(1);
              }
            }
            testImports();
          "
          
          # –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
          echo "2. Checking environment variables..."
          node -e "
            const fs = require('fs');
            const path = require('path');
            
            // –ß–∏—Ç–∞–µ–º .env.example –µ—Å–ª–∏ –µ—Å—Ç—å
            if (fs.existsSync('.env.example')) {
              const envExample = fs.readFileSync('.env.example', 'utf8');
              const requiredVars = envExample
                .split('\\n')
                .filter(line => line.trim() && !line.startsWith('#'))
                .map(line => line.split('=')[0].trim());
              
              console.log('Required variables:', requiredVars);
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ TELEGRAM_TOKEN –µ—Å—Ç—å –≤ –ø—Ä–∏–º–µ—Ä–µ
              if (!requiredVars.some(v => v.includes('TELEGRAM_TOKEN') || v.includes('BOT_TOKEN'))) {
                console.warn('‚ö†Ô∏è  TELEGRAM_TOKEN not found in .env.example');
              }
            } else {
              console.log('‚ÑπÔ∏è  No .env.example file');
            }
          "
          
          # –¢–µ—Å—Ç 3: –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ (5 —Å–µ–∫—É–Ω–¥)
          echo "3. Quick bot startup test..."
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –ª–æ–≥–æ–≤
          LOG_FILE="/tmp/bot_startup_test_$(date +%s).log"
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç –≤ —Ñ–æ–Ω–µ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
          export $(grep -v '^#' .env.test | xargs)
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å —Ç–∞–π–º–∞—É—Ç–æ–º
          timeout 8s node index.js > "$LOG_FILE" 2>&1 &
          BOT_PID=$!
          
          # –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã
          sleep 3
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –µ—â–µ –∂–∏–≤
          if ! kill -0 $BOT_PID 2>/dev/null; then
            echo "‚ùå Bot process died immediately"
            echo "Last output:"
            cat "$LOG_FILE"
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
          if grep -q "‚ùå\|Error:\|ReferenceError\|TypeError\|SyntaxError" "$LOG_FILE"; then
            echo "‚ùå Startup errors detected:"
            echo "========================================"
            grep -A2 -B2 "‚ùå\|Error:\|ReferenceError\|TypeError\|SyntaxError" "$LOG_FILE"
            echo "========================================"
            kill $BOT_PID 2>/dev/null || true
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
          if grep -q "‚úÖ\|started\|launched\|Bot.*running" "$LOG_FILE"; then
            echo "‚úÖ Bot shows startup success messages"
          else
            echo "‚ö†Ô∏è  No startup success messages (might be normal for webhook mode)"
          fi
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç
          kill $BOT_PID 2>/dev/null || true
          sleep 1
          
          echo "‚úÖ Smoke test completed successfully"
          
        env:
          NODE_ENV: test
        
      - name: üìä Common error patterns check
        run: |
          echo "Checking for common error patterns in code..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
          ERROR_FOUND=0
          
          # 1. server is not defined
          if grep -r "server\.on\|server\.listen" src/ --include="*.js" | grep -v "let server\|const server\|var server" | head -5; then
            echo "‚ö†Ô∏è  Found 'server' usage - ensure 'let server' is declared before use"
          fi
          
          # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /start
          if ! grep -r "\/start\|startHandler" src/ --include="*.js" | head -1; then
            echo "‚ùå No /start handler found in source code"
            ERROR_FOUND=1
          fi
          
          # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
          if grep -r "process\.exit(1)" src/ --include="*.js" | grep -v "console.error" | head -3; then
            echo "‚ö†Ô∏è  Found process.exit(1) without error logging"
          fi
          
          # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç—ã
          if grep -r "import.*from.*\.js" src/ --include="*.js" | grep -v "\.js'" | head -3; then
            echo "‚ö†Ô∏è  Found imports without .js extension (might fail in ES modules)"
          fi
          
          if [ $ERROR_FOUND -eq 1 ]; then
            exit 1
          fi
          
          echo "‚úÖ No critical patterns found"
        
      - name: üìù Final summary
        run: |
          echo "========================================"
          echo "‚úÖ ALL CHECKS PASSED"
          echo "‚úÖ Syntax: Valid"
          echo "‚úÖ Imports: Working"
          echo "‚úÖ Startup: No critical errors"
          echo "‚úÖ Files: All present"
          echo "========================================"
          echo "Bot is ready for deployment! üöÄ"
