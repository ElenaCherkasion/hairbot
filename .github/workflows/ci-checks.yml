name: üîç Code Quality & Bot Health Checks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  # –ö–ª—é—á–µ–≤–æ–µ: –ø–µ—Ä–µ–¥–∞—ë–º —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ —Å–µ–∫—Ä–µ—Ç—ã
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
  NODE_ENV: test

jobs:
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v3
        
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: üì¶ Install dependencies
        run: npm ci
        
      - name: üîç ESLint check
        run: |
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
            npx eslint . --ext .js || echo "ESLint warnings found"
          else
            echo "ESLint not configured, skipping"
          fi
        
      - name: üß™ Run unit tests
        run: |
          if [ -f "jest.config.js" ] || [ -f "__tests__" ]; then
            npm test -- --passWithNoTests
          else
            echo "No tests configured, skipping"
          fi
        
      - name: ‚öôÔ∏è Check critical files
        run: |
          echo "Checking essential files..."
          [ -f "index.js" ] || { echo "‚ùå Missing index.js"; exit 1; }
          [ -f "package.json" ] || { echo "‚ùå Missing package.json"; exit 1; }
          [ -f ".env.example" ] || echo "‚ö†Ô∏è  No .env.example file"
          [ -f "src/index.js" ] || { echo "‚ùå Missing src/index.js"; exit 1; }
          echo "‚úÖ All critical files present"
        
      - name: üéØ Syntax validation
        run: |
          echo "Validating JavaScript syntax..."
          node --check index.js || { echo "‚ùå Syntax error in index.js"; exit 1; }
          find src -name "*.js" -exec node --check {} \; || {
            echo "‚ùå Syntax errors found in src files"
            exit 1
          }
          echo "‚úÖ All files have valid syntax"
        
      - name: ü§ñ Bot startup smoke test
        env:
          # –î—É–±–ª–∏—Ä—É–µ–º –∑–¥–µ—Å—å –¥–ª—è –≤–µ—Ä–Ω–æ—Å—Ç–∏
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          DATABASE_URL: ""
          WEBHOOK_BASE_URL: ""
          PORT: "3999"
        run: |
          echo "Running bot startup smoke test..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–æ–∫–µ–Ω –µ—Å—Ç—å
          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "‚ö†Ô∏è  TELEGRAM_TOKEN is empty, using test token"
            export TELEGRAM_TOKEN="test_token_123"
          else
            echo "‚úÖ TELEGRAM_TOKEN is set (length: ${#TELEGRAM_TOKEN})"
          fi
          
          # –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤
          echo "1. Testing module imports..."
          node -e "
            async function testImports() {
              try {
                await import('./index.js');
                console.log('‚úÖ index.js imports OK');
                
                await import('./src/index.js');
                console.log('‚úÖ src/index.js imports OK');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                const fs = require('fs');
                if (fs.existsSync('./src/handlers/start.js')) {
                  await import('./src/handlers/start.js');
                  console.log('‚úÖ start.js imports OK');
                }
                
              } catch (error) {
                console.error('‚ùå Import failed:', error.message);
                console.error('Error location:', error.stack.split('\\\\n')[0]);
                process.exit(1);
              }
            }
            testImports();
          "
          
          # –¢–µ—Å—Ç 2: –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
          echo "2. Quick bot startup test (5 seconds)..."
          
          LOG_FILE="/tmp/bot_startup_$(date +%s).log"
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç –≤ —Ñ–æ–Ω–µ
          timeout 5s node index.js > "$LOG_FILE" 2>&1 &
          BOT_PID=$!
          
          # –ñ–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã
          sleep 2
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∂–∏–≤
          if ! kill -0 $BOT_PID 2>/dev/null; then
            echo "‚ùå Bot process died immediately"
            echo "=== Last 10 lines of output ==="
            tail -10 "$LOG_FILE" || echo "No output"
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
          if grep -q "‚ùå\|ReferenceError\|TypeError\|SyntaxError" "$LOG_FILE"; then
            echo "‚ùå Critical errors detected:"
            echo "========================================"
            grep -A2 -B1 "‚ùå\|ReferenceError\|TypeError\|SyntaxError" "$LOG_FILE" | head -20
            echo "========================================"
            kill $BOT_PID 2>/dev/null || true
            exit 1
          fi
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç
          kill $BOT_PID 2>/dev/null || true
          
          echo "‚úÖ Bot started without critical errors"
          echo "=== Startup log snippet ==="
          tail -5 "$LOG_FILE" || echo "No log output"
        
      - name: üìä Common error patterns check
        run: |
          echo "Checking for common error patterns..."
          
          # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /start
          if ! grep -r "startHandler\|/start" src/ --include="*.js" | head -1; then
            echo "‚ö†Ô∏è  No /start handler found in source code"
          fi
          
          # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ—Ç process.exit –±–µ–∑ –ª–æ–≥–æ–≤
          if grep -r "process\.exit\(1\)" src/ --include="*.js" | grep -v "console\.error\|console\.log" | head -2; then
            echo "‚ö†Ô∏è  Found process.exit(1) without error logging"
          fi
          
          echo "‚úÖ Pattern check completed"
        
      - name: üìù Final summary
        if: always()
        run: |
          echo "========================================"
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ ALL CHECKS PASSED"
            echo "Bot is ready for deployment! üöÄ"
          else
            echo "‚ùå SOME CHECKS FAILED"
            echo "Fix the issues above before deploying."
          fi
          echo "========================================"
