name: 🔍 Code Quality & Bot Health Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      TELEGRAM_TOKEN: test_token_123
      NODE_ENV: test
      PORT: 3999

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: ⎔ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🧪 Import Test
        run: |
          echo "Testing imports..."
          node -e "
          async function testImports() {
            try {
              await import('./index.js');
              console.log('✅ index.js imports OK');
              
              await import('./src/index.js');
              console.log('✅ src/index.js imports OK');
              
              const fs = require('fs');
              if (fs.existsSync('./src/handlers/start.js')) {
                await import('./src/handlers/start.js');
                console.log('✅ start.js imports OK');
              }
            } catch (error) {
              console.error('❌ Import failed:', error.message);
              process.exit(1);
            }
          }
          testImports();
          "

      - name: 🚀 Bot Startup Test (ignore Telegram errors)
        run: |
          echo "Testing bot startup (expecting Telegram 404 with test token)..."
          LOG_FILE="/tmp/bot_test_$(date +%s).log"
          
          # Запускаем бота на 3 секунды
          timeout 3s node index.js > "$LOG_FILE" 2>&1 || true
          
          # Проверяем что бот инициализировался (это главное)
          if grep -q "✅ Bot initialized successfully" "$LOG_FILE"; then
            echo "✅ Bot initialized successfully"
            
            # Игнорируем ошибки Telegram API при тестовом токене
            if grep -q "404: Not Found\|TelegramError" "$LOG_FILE"; then
              echo "⚠️  Telegram API error (expected with test token)"
            fi
            
            # Проверяем на критические ошибки (кроме Telegram)
            if grep -q "ReferenceError\|TypeError\|SyntaxError" "$LOG_FILE"; then
              echo "❌ Critical JavaScript errors found:"
              grep "ReferenceError\|TypeError\|SyntaxError" "$LOG_FILE"
              exit 1
            fi
            
            echo "✅ Smoke test passed"
          else
            echo "❌ Bot failed to initialize"
            echo "=== Log output ==="
            cat "$LOG_FILE"
            exit 1
          fi
