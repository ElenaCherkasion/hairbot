name: 🧪 Тесты качества кода

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  тесты:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    env:
      TELEGRAM_TOKEN: test_token_123
      NODE_ENV: test

    steps:
    - name: 📥 Получить код
      uses: actions/checkout@v4
    
    - name: ⚙️ Установить Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: 📦 Установить зависимости
      run: npm ci
    
    - name: 🧪 Проверка импортов
      run: |
        node -e "
        async function test() {
          try {
            await import('./index.js');
            console.log('✅ index.js - OK');
            await import('./src/index.js');
            console.log('✅ src/index.js - OK');
          } catch(e) {
            console.error('❌ Ошибка:', e.message);
            process.exit(1);
          }
        }
        test();
        "
    
    - name: 🤖 Тест бота
      run: |
        echo "Тестируем инициализацию бота..."
        timeout 2s node index.js 2>&1 | grep -E "✅|❌|Error|инициализирован" || true
        echo "✅ Тест завершен"
