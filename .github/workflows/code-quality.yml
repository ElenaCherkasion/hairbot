name: Code Quality & Bot Health Checks

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      NODE_ENV: test
      TELEGRAM_TOKEN: test_token_123
      DATABASE_URL: ""
      WEBHOOK_BASE_URL: ""
      PORT: 3999
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm install --no-audit --no-fund

      - name: Run unit tests
        run: |
          if npm run | grep -qE '^  test'; then
            npm test
          else
            echo "No test script defined. Skipping."
          fi

      - name: Bot startup smoke test
        run: |
          echo "Running bot startup smoke test..."

          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "⚠️  TELEGRAM_TOKEN is empty, using test token"
            export TELEGRAM_TOKEN="test_token_123"
          else
            echo "✅ TELEGRAM_TOKEN is set (length: ${#TELEGRAM_TOKEN})"
          fi

          echo "1. Testing module imports..."
          node -e "
            async function testImports() {
              try {
                await import('./index.js');
                console.log('✅ index.js imports OK');

                await import('./src/index.js');
                console.log('✅ src/index.js imports OK');

                const fs = require('fs');
                if (fs.existsSync('./src/handlers/start.js')) {
                  await import('./src/handlers/start.js');
                  console.log('✅ start.js imports OK');
                }
              } catch (error) {
                console.error('❌ Import failed:', error.message);
                console.error('Error location:', error.stack.split('\\n')[0]);
                process.exit(1);
              }
            }
            testImports();
          "

          echo "2. Quick bot startup test (5 seconds)..."

          LOG_FILE="/tmp/bot_startup_$(date +%s).log"

          timeout 5s node index.js > "$LOG_FILE" 2>&1 &
          BOT_PID=$!

          sleep 2

          if ! kill -0 $BOT_PID 2>/dev/null; then
            echo "❌ Bot process died immediately"
            echo "=== Last 10 lines of output ==="
            tail -10 "$LOG_FILE" || echo "No output"
            exit 1
          fi

          if grep -q "❌\|ReferenceError\|TypeError\|SyntaxError" "$LOG_FILE"; then
            echo "❌ Critical errors detected:"
            echo "========================================"
            grep -A2 -B1 "❌\|ReferenceError\|TypeError\|SyntaxError" "$LOG_FILE" | head -20
            echo "========================================"
            kill $BOT_PID 2>/dev/null || true
            exit 1
          fi

          kill $BOT_PID 2>/dev/null || true

          echo "✅ Bot started without critical errors"
          echo "=== Startup log snippet ==="
          tail -5 "$LOG_FILE" || echo "No log output"
