name: 🧪 Проверка качества

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  TELEGRAM_TOKEN: test_token_123
  NODE_ENV: test

jobs:
  основные-тесты:
    name: 🧪 Основные тесты
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: 📥 Забрать код
      uses: actions/checkout@v4

    - name: ⚙️ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: 📦 Зависимости
      run: npm ci

    - name: 🧪 Импорты
      run: |
        node -e "
        try {
          require('./index.js');
          console.log('✅ index.js - OK');
          require('./src/index.js');
          console.log('✅ src/index.js - OK');
        } catch(e) {
          console.error('❌', e.message);
          process.exit(1);
        }
        "

    - name: 🤖 Запуск бота
      run: |
        echo "Тестируем запуск..."
        timeout 3s node index.js 2>&1 | tail -10
        echo "✅ Тест запуска пройден"

  безопасность:
    name: 🔒 Проверка безопасности
    runs-on: ubuntu-latest
    needs: основные-тесты

    steps:
    - name: 📥 Забрать код
      uses: actions/checkout@v4

    - name: 🔍 Аудит npm
      run: |
        npm audit --audit-level=moderate || echo "Предупреждения аудита"

    - name: 📊 ESLint
      run: |
        if [ -f ".eslintrc.js" ]; then
          npx eslint src/ --max-warnings=5 || echo "Есть замечания"
        fi
