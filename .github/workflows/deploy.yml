name: ğŸš€ Deploy Node.js Bot to VPS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [closed]

jobs:
  deploy:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true)
    
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v3
        
      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          
      - name: ğŸš€ Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            echo "ğŸš€ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ HairBot..."
            cd /var/www/hairbot
            
            # 1. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ .env
            if [ -f .env ]; then
              cp .env .env.backup_deploy_$(date +%Y%m%d_%H%M%S)
              echo "ğŸ’¾ Backup .env ÑĞ¾Ğ·Ğ´Ğ°Ğ½"
            fi
            
            # 2. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´
            echo "ğŸ“¥ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¸Ğ· GitHub..."
            git fetch origin
            git stash
            git pull origin main
            git stash pop || true
            
            # 3. Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ .env
            if ls .env.backup_deploy_* 1> /dev/null 2>&1; then
              latest_backup=$(ls -t .env.backup_deploy_* | head -1)
              mv "$latest_backup" .env
              echo "ğŸ”§ .env Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ¸Ğ· backup"
            fi
            
            # 4. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
            echo "ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°Ñ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸..."
            npm ci --only=production --no-audit
            
            # 5. ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‡ĞµÑ€ĞµĞ· PM2
            echo "ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ Ğ±Ğ¾Ñ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· PM2..."
            
            if pm2 list | grep -q hairbot; then
              pm2 restart hairbot
              echo "âœ… Ğ‘Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½"
            else
              pm2 start npm --name "hairbot" -- start
              echo "âœ… Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½"
            fi
            
            pm2 save 2>/dev/null || true
            
            # 6. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
            echo "ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ¾ÑĞ»Ğµ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ:"
            pm2 status hairbot || echo "âš ï¸ PM2 status Ğ½Ğµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½"
            
            echo "ğŸ‰ Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½!"
            echo "ğŸ” Ğ›Ğ¾Ğ³Ğ¸: pm2 logs hairbot --lines 20"
          EOF
          
      - name: ğŸ“ Notify
        run: |
          echo "âœ… HairBot ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½ Ğ½Ğ° VPS"
          echo "ğŸ• $(date)"
          echo "ğŸ”— Repository: ${{ github.repository }}"
