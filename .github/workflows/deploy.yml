name: ğŸš€ Deploy to VPS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [closed]

jobs:
  deploy:
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ¾Ğ³Ğ´Ğ° PR Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚ Ğ¸ Ğ²Ğ¼ĞµÑ€Ğ¶ĞµĞ½ Ğ² main
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true)
    
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          
      - name: ğŸš€ Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            echo "ğŸš€ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹..."
            cd /var/www/hairbot
            
            # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ .env
            if [ -f .env ]; then
              cp .env .env.backup_deploy_$(date +%Y%m%d_%H%M%S)
              echo "ğŸ’¾ Backup .env ÑĞ¾Ğ·Ğ´Ğ°Ğ½"
            fi
            
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´ (Ğ½Ğ¾ Ğ½Ğµ .env!)
            git stash
            git pull origin main
            git stash pop || true
            
            # Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ .env Ğ¸Ğ· backup
            if ls .env.backup_deploy_* 1> /dev/null 2>&1; then
              latest_backup=$(ls -t .env.backup_deploy_* | head -1)
              mv "$latest_backup" .env
              echo "ğŸ”§ .env Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ¸Ğ· backup"
            fi
            
            # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹
            docker-compose down
            docker-compose up -d --build
            
            echo "âœ… Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½!"
            echo "ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²:"
            docker-compose ps
          EOF
          
      - name: ğŸ“ Notify
        run: |
          echo "âœ… Successfully deployed to VPS"
          echo "ğŸ• $(date)"
          echo "ğŸ”— Repository: ${{ github.repository }}"
