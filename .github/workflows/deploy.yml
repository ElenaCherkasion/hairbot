on:
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
          set -e
          cd "${{ secrets.VPS_PATH }}"
          git fetch --all
          git reset --hard origin/main
          npm ci --omit=dev
          sudo /usr/bin/pm2 restart hairbot
          sudo /usr/bin/pm2 save
          curl -fsS http://127.0.0.1:3000/health >/dev/null
