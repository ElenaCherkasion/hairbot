name: üöÄ Deploy Node.js Bot to VPS

on:
  push:
    branches: [ main ]
    paths:
      - '**'  # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
  pull_request:
    branches: [ main ]
    types: [closed]

jobs:
  deploy:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true)
    
    runs-on: ubuntu-latest
    
    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # –î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
          
      - name: üîç –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¥–µ–ø–ª–æ—è
        id: check-changes
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Ç–æ–ª—å–∫–æ .env.example
          if git diff --name-only HEAD~1 HEAD | grep -v '.env.example' | wc -l | grep -q '^0$'; then
            echo "üîÑ –ò–∑–º–µ–Ω–µ–Ω —Ç–æ–ª—å–∫–æ .env.example"
            echo "deploy_type=env_sync" >> $GITHUB_OUTPUT
          else
            echo "üöÄ –ü–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π (–∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ)"
            echo "deploy_type=full_deploy" >> $GITHUB_OUTPUT
          fi
          
      - name: üîë Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          
      - name: üöÄ –ë—ã—Å—Ç—Ä–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è .env
        if: steps.check-changes.outputs.deploy_type == 'env_sync'
        run: |
          echo "‚ö° –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é —Ç–æ–ª—å–∫–æ .env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ..."
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
          cat > /tmp/sync_env.sh << 'SCRIPT_EOF'
          #!/bin/bash
          set -e
          echo "üïê –ù–∞—á–∞–ª–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: $(date)"
          
          cd /var/www/hairbot
          
          # 1. Backup —Ç–µ–∫—É—â–µ–≥–æ .env
          if [ -f .env ]; then
            cp .env ".env.backup.$(date +%Y%m%d_%H%M%S)"
            echo "üíæ Backup .env —Å–æ–∑–¥–∞–Ω"
          fi
          
          # 2. –°–∫–∞—á–∏–≤–∞–µ–º .env.example —Å GitHub
          echo "üì• –ó–∞–≥—Ä—É–∂–∞—é —Å–≤–µ–∂–∏–π .env.example..."
          curl -s -o /tmp/.env.example.remote \
            "https://raw.githubusercontent.com/${{ github.repository }}/main/.env.example"
          
          if [ ! -s /tmp/.env.example.remote ]; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å .env.example"
            exit 1
          fi
          
          # 3. –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (—Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è)
          echo "üîß –û–±–Ω–æ–≤–ª—è—é .env —Ñ–∞–π–ª..."
          
          # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª
          > .env.new
          
          # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏–∑ .env.example
          while IFS= read -r line || [[ -n "$line" ]]; do
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
            [[ "$line" =~ ^[[:space:]]*# ]] && continue
            [[ "$line" =~ ^[[:space:]]*$ ]] && continue
            
            var_name=$(echo "$line" | cut -d= -f1)
            
            # –ò—â–µ–º –≤ —Ç–µ–∫—É—â–µ–º .env
            if [ -f .env ] && grep -q "^${var_name}=" .env; then
              # –ë–µ—Ä–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
              grep "^${var_name}=" .env >> .env.new
              echo "  üîÑ –°–æ—Ö—Ä–∞–Ω–∏–ª —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ: $var_name"
            else
              # –ë–µ—Ä–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
              echo "$line" >> .env.new
              echo "  ‚úÖ –î–æ–±–∞–≤–∏–ª –Ω–æ–≤—É—é: $var_name"
            fi
          done < /tmp/.env.example.remote
          
          # –ó–∞–º–µ–Ω—è–µ–º —Ñ–∞–π–ª
          mv .env.new .env
          rm -f /tmp/.env.example.remote
          
          # 4. –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ PM2 (–±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞)
          echo "üîÑ –û–±–Ω–æ–≤–ª—è—é –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è PM2..."
          pm2 reload hairbot --update-env 2>/dev/null || true
          
          echo "‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ ~5 —Å–µ–∫"
          echo "üìä –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:"
          grep -v '^#' .env | grep -v '^$'
          echo "üïê –ö–æ–Ω–µ—Ü —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: $(date)"
          SCRIPT_EOF
          
          # –ö–æ–ø–∏—Ä—É–µ–º –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –Ω–∞ VPS
          scp -o StrictHostKeyChecking=no /tmp/sync_env.sh \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/tmp/sync_env.sh
          
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "chmod +x /tmp/sync_env.sh && /tmp/sync_env.sh"
            
      - name: üöÄ –ü–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π
        if: steps.check-changes.outputs.deploy_type == 'full_deploy'
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            echo "üöÄ –ù–∞—á–∏–Ω–∞—é –¥–µ–ø–ª–æ–π HairBot..."
            cd /var/www/hairbot
            
            # 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π .env
            if [ -f .env ]; then
              cp .env .env.backup_deploy_$(date +%Y%m%d_%H%M%S)
              echo "üíæ Backup .env —Å–æ–∑–¥–∞–Ω"
            fi
            
            # 2. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            echo "üì• –ü–æ–ª—É—á–∞—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ GitHub..."
            git fetch origin
            git stash
            git pull origin main
            git stash pop || true
            
            # 3. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .env
            if ls .env.backup_deploy_* 1> /dev/null 2>&1; then
              latest_backup=$(ls -t .env.backup_deploy_* | head -1)
              mv "$latest_backup" .env
              echo "üîß .env –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ backup"
            fi
            
            # 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            npm ci --only=production --no-audit
            
            # 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ PM2
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞ —á–µ—Ä–µ–∑ PM2..."
            
            if pm2 list | grep -q hairbot; then
              pm2 restart hairbot --update-env
              echo "‚úÖ –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
            else
              pm2 start npm --name "hairbot" -- start
              echo "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω"
            fi
            
            pm2 save 2>/dev/null || true
            
            # 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "üìä –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:"
            pm2 status hairbot || echo "‚ö†Ô∏è PM2 status –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω"
            
            echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
            echo "üîç –õ–æ–≥–∏: pm2 logs hairbot --lines 20"
          EOF
          
      - name: üìù Notify
        run: |
          if [ "${{ steps.check-changes.outputs.deploy_type }}" == "env_sync" ]; then
            echo "‚ö° .env —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω –∑–∞ ~10 —Å–µ–∫—É–Ω–¥"
          else
            echo "üöÄ –ü–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω"
          fi
          echo "üïê $(date)"
          echo "üîó Repository: ${{ github.repository }}"
