name: "✅ Проверка бота"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  TELEGRAM_TOKEN: "test_token_123"
  NODE_ENV: "test"

jobs:
  basic-checks:
    name: "🧪 Базовые проверки"
    runs-on: ubuntu-latest
    
    steps:
    - name: "📥 Получить код"
      uses: actions/checkout@v4
    
    - name: "⚙️ Установить Node.js"
      uses: actions/setup-node@v4
      with:
        node-version: "20"
        cache: "npm"
    
    - name: "🔍 Проверить структуру файлов"
      run: |
        echo "Проверяем обязательные файлы..."
        
        # Обязательные файлы
        for file in index.js src/index.js package.json; do
          if [ -f "$file" ]; then
            echo "✅ $file существует"
          else
            echo "❌ $file отсутствует"
            exit 1
          fi
        done
        
        # Проверяем на конфликтные маркеры
        echo "Проверяем на конфликты git..."
        if find . -name "*.js" -o -name "*.json" | xargs grep -l "<<<<<<<" 2>/dev/null; then
          echo "❌ Обнаружены конфликтные маркеры git"
          exit 1
        fi
        echo "✅ Конфликтных маркеров нет"
    
    - name: "📦 Проверить package.json"
      run: |
        echo "Проверяем package.json..."
        node -e "
        try {
          const pkg = JSON.parse(require('fs').readFileSync('package.json', 'utf8'));
          if (!pkg.name || !pkg.version) {
            throw new Error('Отсутствуют обязательные поля в package.json');
          }
          console.log('✅ package.json валиден:', pkg.name, pkg.version);
        } catch(e) {
          console.error('❌ Ошибка в package.json:', e.message);
          process.exit(1);
        }
        "
    
    - name: "🧪 Проверить импорты"
      run: |
        echo "Проверяем импорты основных файлов..."
        node -e "
        async function test() {
          const tests = [
            {name: 'index.js', file: './index.js'},
            {name: 'src/index.js', file: './src/index.js'}
          ];
          
          for (const test of tests) {
            try {
              await import(test.file);
              console.log('✅ ' + test.name + ' - OK');
            } catch(e) {
              // Игнорируем ошибки Telegram API (ожидаемы с тестовым токеном)
              if (e.message.includes('404') || e.message.includes('Not Found')) {
                console.log('⚠️ ' + test.name + ' - Telegram error (нормально для теста)');
              } else {
                console.error('❌ ' + test.name + ' - ' + e.message);
                process.exit(1);
              }
            }
          }
          console.log('✅ Все импорты проверены');
        }
        
        test().catch(e => {
          console.error('❌ Непредвиденная ошибка:', e.message);
          process.exit(1);
        });
        "
    
    - name: "🤖 Тест запуска бота"
      run: |
        echo "Тестируем запуск бота..."
        echo "Используется тестовый токен, ожидаем ошибку Telegram API..."
        
        # Запускаем бота на 2 секунды
        timeout 2s node index.js 2>&1 | tee /tmp/bot_output.log
        
        # Проверяем что бот хотя бы инициализировался
        if grep -q "✅ Bot initialized\|Bot initialized successfully" /tmp/bot_output.log; then
          echo "✅ Бот успешно инициализирован"
          
          # Проверяем на критические ошибки (кроме Telegram)
          if grep -q -E "ReferenceError|TypeError|SyntaxError" /tmp/bot_output.log; then
            echo "❌ Обнаружены критические ошибки JavaScript:"
            grep -E "ReferenceError|TypeError|SyntaxError" /tmp/bot_output.log
            exit 1
          fi
          
          echo "✅ Тест пройден (Telegram ошибки игнорируются как ожидаемые)"
        else
          echo "❌ Бот не инициализировался"
          exit 1
        fi
    
    - name: "📊 Отчет"
      if: always()
      run: |
        if [[ "${{ job.status }}" == "success" ]]; then
          echo "## ✅ Все проверки пройдены!" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Структура файлов в порядке" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ package.json валиден" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Импорты работают" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Бот инициализируется" >> $GITHUB_STEP_SUMMARY
          echo "- ⚠️ Telegram API ошибки игнорируются (тестовый токен)" >> $GITHUB_STEP_SUMMARY
        else
          echo "## ❌ Проверки не пройдены" >> $GITHUB_STEP_SUMMARY
          echo "Требуется исправление кода." >> $GITHUB_STEP_SUMMARY
        fi
