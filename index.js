import dotenv from "dotenv";
dotenv.config();

import express from "express";
import fetch from "node-fetch";

const app = express();
app.use(express.json());

const TELEGRAM_TOKEN = process.env.TELEGRAM_TOKEN;
if (!TELEGRAM_TOKEN) throw new Error("TELEGRAM_TOKEN is missing");

const TELEGRAM_API = `https://api.telegram.org/bot${TELEGRAM_TOKEN}`;

// ---------- Telegram helpers ----------
async function tg(method, payload) {
  const r = await fetch(`${TELEGRAM_API}/${method}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });
  const data = await r.json();
  if (!data.ok) {
    console.error("Telegram API error:", method, data);
  }
  return data;
}

async function sendMessage(chatId, text, replyMarkup) {
  return tg("sendMessage", {
    chat_id: chatId,
    text,
    reply_markup: replyMarkup,
  });
}

async function editMessageText(chatId, messageId, text, replyMarkup) {
  return tg("editMessageText", {
    chat_id: chatId,
    message_id: messageId,
    text,
    reply_markup: replyMarkup,
  });
}

async function answerCallbackQuery(callbackQueryId) {
  return tg("answerCallbackQuery", { callback_query_id: callbackQueryId });
}

// ---------- UI (Main Menu) ----------
const MAIN_MENU_TEXT =
  "ðŸ  Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ HAIRbot\n\n" +
 "HAIRbot â€” ÑÐµÑ€Ð²Ð¸Ñ Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð²Ð½ÐµÑˆÐ½Ð¾ÑÑ‚Ð¸ Ð¸ Ð¿Ð¾Ð´Ð±Ð¾Ñ€Ð° Ð½Ð°Ð¸Ð±Ð¾Ð»ÐµÐµ ÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ñ… Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð²Ð¾Ð»Ð¾Ñ.\n\n" +
  "Ð‘Ð¾Ñ‚ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ Ð»Ð¸Ñ†Ð¾ Ð³ÐµÐ¾Ð¼ÐµÑ‚Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸, ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ñƒ (Ð² Ñ‚Ð¾Ð¼ Ñ‡Ð¸ÑÐ»Ðµ ÑÐ¼ÐµÑˆÐ°Ð½Ð½ÑƒÑŽ), Ð¿Ñ€Ð¾Ð¿Ð¾Ñ€Ñ†Ð¸Ð¸, Ð´Ð¸Ð½Ð°Ð¼Ð¸ÐºÑƒ Ñ‡ÐµÑ€Ñ‚ Ð¸ Ð¸Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð²Ð½ÐµÑˆÐ½Ð¾ÑÑ‚Ð¸.\n" +
  "ÐÐ° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑÑ‚Ð¾Ð³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð¾Ð½ Ð¿Ð¾Ð´Ð±Ð¸Ñ€Ð°ÐµÑ‚ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð´Ð»Ð¸Ð½Ñ‹, Ñ„Ð¾Ñ€Ð¼Ñ‹, Ñ‡Ñ‘Ð»ÐºÐ¸, Ñ‚ÐµÐºÑÑ‚ÑƒÑ€Ñ‹ Ð²Ð¾Ð»Ð¾Ñ Ð¸ Ñ†Ð²ÐµÑ‚Ð¾Ð²Ñ‹Ñ… Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹ â€” Ñ‚Ð°Ðº, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð´Ñ‡ÐµÑ€ÐºÐ½ÑƒÑ‚ÑŒ ÑÐ¸Ð»ÑŒÐ½Ñ‹Ðµ ÑÑ‚Ð¾Ñ€Ð¾Ð½Ñ‹ Ð²Ð½ÐµÑˆÐ½Ð¾ÑÑ‚Ð¸, Ð¾ÑÐ²ÐµÐ¶Ð¸Ñ‚ÑŒ Ð»Ð¸Ñ†Ð¾ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð³Ð°Ñ€Ð¼Ð¾Ð½Ð¸ÑŽ.\n\n" 

const MAIN_MENU_KB = {
  inline_keyboard: [
    [{ text: "ÐŸÑ€Ð¾Ð±Ð½Ñ‹Ð¹ Free", callback_data: "flow_free" }],
    [{ text: "Ð¡Ñ‚Ñ€Ð¸Ð¶ÐºÐ° + Ð°Ð½Ð°Ð»Ð¸Ð· Ñ†Ð²ÐµÑ‚Ð°", callback_data: "flow_basic" }],
    [{ text: "Ð¡Ñ‚Ñ€Ð¸Ð¶ÐºÐ° + Ð°Ð½Ð°Ð»Ð¸Ð· Ñ†Ð²ÐµÑ‚Ð° + ÑÑ€ÐºÐ¸Ðµ Ð¾Ñ‚Ñ‚ÐµÐ½ÐºÐ¸", callback_data: "flow_pro" }],
    [{ text: "ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð¾Ð±Ñ€Ð°Ð·", callback_data: "flow_premium" }],
    [{ text: "5 Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¹ Ñ†Ð²ÐµÑ‚Ð° Ð¿Ð¾ Ñ€ÐµÑ„ÐµÑ€ÐµÐ½ÑÑƒ", callback_data: "flow_colorref1" }],
    [{ text: "10 Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¹ Ñ†Ð²ÐµÑ‚Ð° Ð¿Ð¾ Ñ€ÐµÑ„ÐµÑ€ÐµÐ½ÑÑƒ", callback_data: "flow_colorref10" }],
    [
      { text: "ðŸ’³ Ð¢Ð°Ñ€Ð¸Ñ„Ñ‹", callback_data: "info_pricing" },
      { text: "ðŸ“¸ ÐšÐ°Ðº ÑÑ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒÑÑ", callback_data: "info_photo" },
    ],
    [{ text: "â„¹ï¸ Ðž ÑÐµÑ€Ð²Ð¸ÑÐµ", callback_data: "info_about" }],
  ],
};

const BACK_TO_MENU_KB = {
  inline_keyboard: [[{ text: "ðŸ  Ð’ Ð¼ÐµÐ½ÑŽ", callback_data: "nav_menu" }]],
};

// ---------- Texts for info screens (minimal, you can edit later) ----------
const ABOUT_TEXT =
  "â„¹ï¸ Ðž ÑÐµÑ€Ð²Ð¸ÑÐµ\n\n" +
  "HAIRbot â€” ÑÐµÑ€Ð²Ð¸Ñ Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð²Ð½ÐµÑˆÐ½Ð¾ÑÑ‚Ð¸ Ð¸ Ð¿Ð¾Ð´Ð±Ð¾Ñ€Ð° Ð½Ð°Ð¸Ð±Ð¾Ð»ÐµÐµ ÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ñ… Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð²Ð¾Ð»Ð¾Ñ.\n\n" +
  "Ð‘Ð¾Ñ‚ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ Ð»Ð¸Ñ†Ð¾ Ð³ÐµÐ¾Ð¼ÐµÑ‚Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸, ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ñƒ (Ð² Ñ‚Ð¾Ð¼ Ñ‡Ð¸ÑÐ»Ðµ ÑÐ¼ÐµÑˆÐ°Ð½Ð½ÑƒÑŽ), Ð¿Ñ€Ð¾Ð¿Ð¾Ñ€Ñ†Ð¸Ð¸, Ð´Ð¸Ð½Ð°Ð¼Ð¸ÐºÑƒ Ñ‡ÐµÑ€Ñ‚ Ð¸ Ð¸Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð²Ð½ÐµÑˆÐ½Ð¾ÑÑ‚Ð¸.\n" +
  "ÐÐ° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑÑ‚Ð¾Ð³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð¾Ð½ Ð¿Ð¾Ð´Ð±Ð¸Ñ€Ð°ÐµÑ‚ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð´Ð»Ð¸Ð½Ñ‹, Ñ„Ð¾Ñ€Ð¼Ñ‹, Ñ‡Ñ‘Ð»ÐºÐ¸, Ñ‚ÐµÐºÑÑ‚ÑƒÑ€Ñ‹ Ð²Ð¾Ð»Ð¾Ñ Ð¸ Ñ†Ð²ÐµÑ‚Ð¾Ð²Ñ‹Ñ… Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹ â€” Ñ‚Ð°Ðº, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð´Ñ‡ÐµÑ€ÐºÐ½ÑƒÑ‚ÑŒ ÑÐ¸Ð»ÑŒÐ½Ñ‹Ðµ ÑÑ‚Ð¾Ñ€Ð¾Ð½Ñ‹ Ð²Ð½ÐµÑˆÐ½Ð¾ÑÑ‚Ð¸, Ð¾ÑÐ²ÐµÐ¶Ð¸Ñ‚ÑŒ Ð»Ð¸Ñ†Ð¾ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð³Ð°Ñ€Ð¼Ð¾Ð½Ð¸ÑŽ.\n\n" +
  "ÐÐ½Ð°Ð»Ð¸Ð· ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑÑ Ð½Ðµ Ð½Ð° ÑˆÐ°Ð±Ð»Ð¾Ð½Ð°Ñ…, Ð° Ð½Ð° ÑÐ¾Ñ‡ÐµÑ‚Ð°Ð½Ð¸Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð²:\n" +
  "Ð³ÐµÐ¾Ð¼ÐµÑ‚Ñ€Ð¸Ð¸ Ð»Ð¸Ñ†Ð°, Ð¿Ð¾Ð»Ð½Ð¾Ñ‚Ñ‹, Ð»Ð±Ð°, ÑÐºÑƒÐ», Ð»Ð¸Ð½Ð¸Ð¸ Ñ‡ÐµÐ»ÑŽÑÑ‚Ð¸, Ð° Ñ‚Ð°ÐºÐ¶Ðµ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹ â€” Ð±Ñ€Ð¾Ð²ÐµÐ¹, Ð³ÑƒÐ±, Ð½Ð¾ÑÐ° Ð¸ ÑƒÑˆÐµÐ¹ (Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¼Ð¸, Ð¼ÑÐ³ÐºÐ¸Ð¼Ð¸ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸ÑÐ¼Ð¸).\n\n" +
  "ðŸŽ¨ ÐŸÐ¾Ð´Ð±Ð¾Ñ€ Ñ†Ð²ÐµÑ‚Ð° Ð¾ÑÐ½Ð¾Ð²Ð°Ð½ Ð½Ð° Ð¿Ñ€Ð¸Ð½Ñ†Ð¸Ð¿Ð°Ñ… ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ ÐœÐ°Ð½ÑÐµÐ»Ð»Ð°: ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÑŽÑ‚ÑÑ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð° Ð¸ Ñ‚Ð¾Ð½ ÐºÐ¾Ð¶Ð¸, Ð¿Ñ€Ð¸Ñ€Ð¾Ð´Ð½Ð°Ñ ÐºÐ¾Ð½Ñ‚Ñ€Ð°ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ Ð¸ Ð½Ð°ÑÑ‹Ñ‰ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ð²Ð½ÐµÑˆÐ½Ð¾ÑÑ‚Ð¸.\n" +
  "Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÑŽÑ‚ÑÑ Ð½Ð°Ð¸Ð±Ð¾Ð»ÐµÐµ Ð³Ð°Ñ€Ð¼Ð¾Ð½Ð¸Ñ‡Ð½Ñ‹Ðµ, ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ Ð¾Ñ‚Ñ‚ÐµÐ½ÐºÐ¸, Ð° Ð·Ð°Ñ‚ÐµÐ¼ â€” ÑÑ€ÐºÐ¸Ðµ Ñ‚Ñ€ÐµÐ½Ð´Ð¾Ð²Ñ‹Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹, Ð¿Ð¾Ð´Ð¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¿Ð¾ Ñ†Ð²ÐµÑ‚Ð¾Ð²Ð¾Ð¹ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ðµ ÐºÐ¾Ð¶Ð¸ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ñ€Ñ‹Ð¶Ð¸Ðµ, cherry Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð°ÐºÑ†ÐµÐ½Ñ‚Ð½Ñ‹Ðµ Ð¾Ñ‚Ñ‚ÐµÐ½ÐºÐ¸).\n\n" +
  "ðŸŒ€ Ð’ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ñ… Ñ‚Ð°Ñ€Ð¸Ñ„Ð°Ñ… ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÑŽÑ‚ÑÑ Ñ‚ÐµÐºÑÑ‚ÑƒÑ€Ñ‹ Ð²Ð¾Ð»Ð¾Ñ:\n" +
  "Ð±Ð¸Ð¾Ð·Ð°Ð²Ð¸Ð²ÐºÐ° (Ñ Ñ€Ð°ÑÑ‡Ñ‘Ñ‚Ð¾Ð¼ ÐºÐ¾ÑÑ„Ñ„Ð¸Ñ†Ð¸ÐµÐ½Ñ‚Ð° Ð·Ð°Ð²Ð¸Ñ‚ÐºÐ° Ð¸ Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑƒÐºÐ¾Ñ€Ð¾Ñ‡ÐµÐ½Ð¸Ñ Ð´Ð»Ð¸Ð½Ñ‹) Ð¸ ÐºÐµÑ€Ð°Ñ‚Ð¸Ð½Ð¾Ð²Ð¾Ðµ Ð²Ñ‹Ð¿Ñ€ÑÐ¼Ð»ÐµÐ½Ð¸Ðµ â€” Ñ Ð¿Ð¾ÑÑÐ½ÐµÐ½Ð¸ÐµÐ¼, ÐºÐ°Ðº Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑÑ Ñ„Ð¾Ñ€Ð¼Ð° Ð¸ ÑÐ¸Ð»ÑƒÑÑ‚ Ñƒ Ð»Ð¸Ñ†Ð°.\n\n" +
  "ðŸ”¹ ÐÐ° Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼ ÑÑ‚Ð°Ð¿Ðµ ÑÐµÑ€Ð²Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð´Ð»Ñ Ð¶ÐµÐ½ÑÐºÐ¾Ð¹ Ð²Ð½ÐµÑˆÐ½Ð¾ÑÑ‚Ð¸.\n" +
  "ðŸ”¹ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ ÐºÐ°Ðº Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð»Ð»ÑŽÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ðº Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸ÑÐ¼, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ð³Ð»ÑÐ´Ð½Ð¾ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹.\n" +
  "Ð­Ñ‚Ð¾ Ð½Ðµ ÑÐµÑ€Ð²Ð¸Ñ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¾Ð¹ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÐºÐ°Ñ€Ñ‚Ð¸Ð½Ð¾Ðº, Ð° Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐ¾Ð¿Ñ€Ð¾Ð²Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¾ÑÐ¾Ð·Ð½Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð´Ð±Ð¾Ñ€Ð°.\n\n" +
  "HAIRbot Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ Ð¿Ð¾Ð½ÑÑ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¿Ð¾Ð´Ð¾Ð¹Ð´Ñ‘Ñ‚ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ð²Ð°Ð¼, ÐµÑ‰Ñ‘ Ð´Ð¾ Ð²Ð¸Ð·Ð¸Ñ‚Ð° Ð² ÑÐ°Ð»Ð¾Ð½ â€” Ð¸ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð²Ñ‹Ð±Ð¾Ñ€ Ð±Ð¾Ð»ÐµÐµ ÑƒÐ²ÐµÑ€ÐµÐ½Ð½Ð¾ Ð¸ ÑÐ¿Ð¾ÐºÐ¾Ð¹Ð½Ð¾.";

const PHOTO_TIPS_TEXT =
  "ðŸ“¸ ÐšÐ°Ðº ÑÑ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒÑÑ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾\n\n" +
  "Ð§Ñ‚Ð¾Ð±Ñ‹ Ð°Ð½Ð°Ð»Ð¸Ð· Ð±Ñ‹Ð» Ñ‚Ð¾Ñ‡Ð½Ñ‹Ð¼:\n" +
  "â€¢ Ð´Ð½ÐµÐ²Ð½Ð¾Ð¹ ÑÐ²ÐµÑ‚ Ñƒ Ð¾ÐºÐ½Ð°\n" +
  "â€¢ Ð±ÐµÐ· Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð²\n" +
  "â€¢ Ð°Ð½Ñ„Ð°Ñ, ÐºÐ°Ð¼ÐµÑ€Ð° Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ Ð³Ð»Ð°Ð·\n" +
  "â€¢ Ð²Ð¾Ð»Ð¾ÑÑ‹ ÑƒÐ±Ñ€Ð°Ð½Ñ‹ Ð¾Ñ‚ Ð»Ð¸Ñ†Ð° (Ð»Ð¾Ð±/ÑÐºÑƒÐ»Ñ‹/Ñ‡ÐµÐ»ÑŽÑÑ‚ÑŒ Ð²Ð¸Ð´Ð½Ñ‹)\n" +
  "â€¢ Ð»Ð¸Ñ†Ð¾ Ñ†ÐµÐ»Ð¸ÐºÐ¾Ð¼ Ð² ÐºÐ°Ð´Ñ€Ðµ, Ð±ÐµÐ· Ð¾Ð±Ñ€ÐµÐ·Ð°Ð½Ð¸Ð¹\n" +
  "â€¢ Ñ„Ð¾Ð½ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹, Ñ„Ð¾Ñ‚Ð¾ Ñ€ÐµÐ·ÐºÐ¾Ðµ\n\n" +
  "ÐŸÐ¾ÑÐ»Ðµ ÑÑ‚Ð¾Ð³Ð¾ Ð¼Ð¾Ð¶Ð½Ð¾ Ð½Ð°Ñ‡Ð¸Ð½Ð°Ñ‚ÑŒ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ Ð¸Ð· Ð¼ÐµÐ½ÑŽ.";

const PRICING_TEXT =
  "ðŸ’³ Ð¢Ð°Ñ€Ð¸Ñ„Ñ‹ (ÐºÑ€Ð°Ñ‚ÐºÐ¾)\n\n" +
  "âœ… FREE â€” 0 â‚½ (1 Ñ€Ð°Ð·)\n" +
  "â€¢ Ð°Ð½Ð°Ð»Ð¸Ð· Ñ„Ð¾Ñ€Ð¼Ñ‹/Ð´Ð»Ð¸Ð½Ñ‹/Ñ‚ÐµÐºÑÑ‚ÑƒÑ€Ñ‹\n" +
  "â€¢ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÑ‚Ñ€Ð¸Ð¶ÐºÐ¸: 1Ã— (2 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°) â€” Ð¿Ð¾ ÐºÐ½Ð¾Ð¿ÐºÐµ\n\n" +
  "âœ¨ BASIC â€” 399 â‚½\n" +
  "â€¢ ÑÑ‚Ñ€Ð¸Ð¶ÐºÐ°: 1Ã— (4 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°)\n" +
  "â€¢ Ñ†Ð²ÐµÑ‚ Ð¿Ð¾ ÐœÐ°Ð½ÑÐµÐ»Ð»Ñƒ: 1Ã— (4 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°)\n\n" +
  "ðŸŒˆ PRO â€” 899 â‚½\n" +
  "â€¢ + Ñ†Ð²ÐµÑ‚ Ð¿Ð¾ ÐœÐ°Ð½ÑÐµÐ»Ð»Ñƒ (4 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°)\n" +
  "â€¢ + ÑÑ€ÐºÐ¸Ðµ Ð¾Ñ‚Ñ‚ÐµÐ½ÐºÐ¸ (4 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°)\n\n" +
  "ðŸ’Ž PREMIUM â€” 1 590 â‚½\n" +
  "â€¢ + Ð±Ð¸Ð¾Ð·Ð°Ð²Ð¸Ð²ÐºÐ°/ÐºÐµÑ€Ð°Ñ‚Ð¸Ð½ (Ð¿Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÑƒ)\n" +
  "â€¢ + Ð°ÐºÑÐµÑÑƒÐ°Ñ€Ñ‹ (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ + 4 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°)\n\n" +
  "ðŸŽ¨ COLOR REF 5 â€” 499 â‚½\n" +
  "â€¢ Ð¿Ð°ÐºÐµÑ‚ 5 Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¹ Ñ†Ð²ÐµÑ‚Ð° Ð¿Ð¾ Ñ€ÐµÑ„ÐµÑ€ÐµÐ½ÑÐ°Ð¼\n\n" +
  "ðŸŽ¨ COLOR REF 10 â€” 899 â‚½\n" +
  "â€¢ Ð¿Ð°ÐºÐµÑ‚ 10 Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¹ Ñ†Ð²ÐµÑ‚Ð° Ð¿Ð¾ Ñ€ÐµÑ„ÐµÑ€ÐµÐ½ÑÐ°Ð¼";

// ---------- Webhook ----------
app.post("/webhook", async (req, res) => {
  try {
    const update = req.body;
    console.log("âœ… WEBHOOK HIT");

    // /start -> show main menu
    if (update.message?.text === "/start") {
      const chatId = update.message.chat.id;
      await sendMessage(chatId, MAIN_MENU_TEXT, MAIN_MENU_KB);
      return res.sendStatus(200);
    }

    // button clicks
    if (update.callback_query) {
      const cq = update.callback_query;
      const chatId = cq.message.chat.id;
      const messageId = cq.message.message_id;
      const data = cq.data;

      await answerCallbackQuery(cq.id);

      // Navigation
      if (data === "nav_menu") {
        await editMessageText(chatId, messageId, MAIN_MENU_TEXT, MAIN_MENU_KB);
        return res.sendStatus(200);
      }

      // Info screens
      if (data === "info_about") {
        await editMessageText(chatId, messageId, ABOUT_TEXT, BACK_TO_MENU_KB);
        return res.sendStatus(200);
      }
      if (data === "info_photo") {
        await editMessageText(chatId, messageId, PHOTO_TIPS_TEXT, BACK_TO_MENU_KB);
        return res.sendStatus(200);
      }
      if (data === "info_pricing") {
        await editMessageText(chatId, messageId, PRICING_TEXT, BACK_TO_MENU_KB);
        return res.sendStatus(200);
      }

      // Flow placeholders (no business logic yet)
      // Ð¢ÑƒÑ‚ Ð¿Ð¾Ð·Ð¶Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ð¼ Ð²Ñ‹Ð±Ð¾Ñ€ Ñ‚Ð°Ñ€Ð¸Ñ„Ð°, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ Ñ„Ð¾Ñ‚Ð¾, Ð°Ð½Ð°Ð»Ð¸Ð·, ÐºÐ½Ð¾Ð¿ÐºÑƒ "Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹?"
      const flowMap = {
        flow_free:
          "âœ… Ð’Ñ‹Ð±Ñ€Ð°Ð½: FREE\n\n" +
          "Ð­Ñ‚Ð¾Ñ‚ Ñ€ÐµÐ¶Ð¸Ð¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ 1 Ñ€Ð°Ð·.\n" +
          "Ð”Ð°Ð»ÑŒÑˆÐµ Ð¼Ñ‹ Ð¿Ð¾Ð¿Ñ€Ð¾ÑÐ¸Ð¼ Ñ„Ð¾Ñ‚Ð¾ (Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¾Ð¹ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð°), ÑÐ´ÐµÐ»Ð°ÐµÐ¼ Ð°Ð½Ð°Ð»Ð¸Ð· Ð¸ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ð¼ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸.\n\n" +
          "ÐŸÐ¾ÐºÐ° ÑÑ‚Ð¾ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ° Ð¼ÐµÐ½ÑŽ.",
        flow_basic:
          "âœ¨ Ð’Ñ‹Ð±Ñ€Ð°Ð½: BASIC (Ð¤Ð¾Ñ€Ð¼Ð° + Ñ†Ð²ÐµÑ‚)\n\n" +
          "Ð”Ð°Ð»ÑŒÑˆÐµ: Ñ„Ð¾Ñ‚Ð¾ â†’ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° â†’ Ð°Ð½Ð°Ð»Ð¸Ð· â†’ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¹ (Ð¿Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÑƒ).\n\n" +
          "ÐŸÐ¾ÐºÐ° ÑÑ‚Ð¾ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ° Ð¼ÐµÐ½ÑŽ.",
        flow_pro:
          "ðŸŒˆ Ð’Ñ‹Ð±Ñ€Ð°Ð½: PRO (Ð¤Ð¾Ñ€Ð¼Ð° + Ñ†Ð²ÐµÑ‚ + Ð°ÐºÑ†ÐµÐ½Ñ‚)\n\n" +
          "Ð”Ð°Ð»ÑŒÑˆÐµ: Ñ„Ð¾Ñ‚Ð¾ â†’ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° â†’ Ð°Ð½Ð°Ð»Ð¸Ð· â†’ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ñ†Ð²ÐµÑ‚Ð°/ÑÑ€ÐºÐ¸Ñ… Ð¾Ñ‚Ñ‚ÐµÐ½ÐºÐ¾Ð² (Ð¿Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÑƒ).\n\n" +
          "ÐŸÐ¾ÐºÐ° ÑÑ‚Ð¾ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ° Ð¼ÐµÐ½ÑŽ.",
        flow_premium:
          "ðŸ’Ž Ð’Ñ‹Ð±Ñ€Ð°Ð½: PREMIUM (ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð¾Ð±Ñ€Ð°Ð·)\n\n" +
          "Ð”Ð°Ð»ÑŒÑˆÐµ: Ñ„Ð¾Ñ‚Ð¾ â†’ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° â†’ Ð°Ð½Ð°Ð»Ð¸Ð· â†’ Ð±Ð¸Ð¾Ð·Ð°Ð²Ð¸Ð²ÐºÐ° Ð¸ ÑÐµÑ€ÑŒÐ³Ð¸ (Ð¿Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÑƒ).\n\n" +
          "ÐŸÐ¾ÐºÐ° ÑÑ‚Ð¾ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ° Ð¼ÐµÐ½ÑŽ.",
        flow_colorref1:
          "ðŸŽ¨ Ð’Ñ‹Ð±Ñ€Ð°Ð½: COLOR REF 5\n\n" +
          "ÐŸÐ°ÐºÐµÑ‚ 5 Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¹ Ñ†Ð²ÐµÑ‚Ð° Ð¿Ð¾ Ñ€ÐµÑ„ÐµÑ€ÐµÐ½ÑÐ°Ð¼.\n" +
          "ÐÑƒÐ¶Ð½Ð¾: Ñ€ÐµÑ„ÐµÑ€ÐµÐ½Ñ Ñ†Ð²ÐµÑ‚Ð° + Ñ‚Ð²Ð¾Ñ‘ Ñ„Ð¾Ñ‚Ð¾.\n\n" +
          "ÐŸÐ¾ÐºÐ° ÑÑ‚Ð¾ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ° Ð¼ÐµÐ½ÑŽ.",
        flow_colorref10:
          "ðŸŽ¨ Ð’Ñ‹Ð±Ñ€Ð°Ð½: COLOR REF 10\n\n" +
          "ÐŸÐ°ÐºÐµÑ‚ 10 Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¹ Ñ†Ð²ÐµÑ‚Ð° Ð¿Ð¾ Ñ€ÐµÑ„ÐµÑ€ÐµÐ½ÑÐ°Ð¼.\n" +
          "ÐÑƒÐ¶Ð½Ð¾: Ñ€ÐµÑ„ÐµÑ€ÐµÐ½Ñ Ñ†Ð²ÐµÑ‚Ð° + Ñ‚Ð²Ð¾Ñ‘ Ñ„Ð¾Ñ‚Ð¾.\n\n" +
          "ÐŸÐ¾ÐºÐ° ÑÑ‚Ð¾ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ° Ð¼ÐµÐ½ÑŽ.",
      };

      if (flowMap[data]) {
        await editMessageText(chatId, messageId, flowMap[data], BACK_TO_MENU_KB);
        return res.sendStatus(200);
      }

      // default fallback
      await editMessageText(chatId, messageId, "ÐÐµ Ð¿Ð¾Ð½ÑÐ» ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ ðŸ™‚", BACK_TO_MENU_KB);
      return res.sendStatus(200);
    }

    return res.sendStatus(200);
  } catch (err) {
    console.error("Webhook handler error:", err);
    return res.sendStatus(200);
  }
});

app.get("/health", (req, res) => res.send("OK"));

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log("Bot running on port", PORT);
});
